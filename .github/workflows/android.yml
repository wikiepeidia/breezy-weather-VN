name: Android CI/CD

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build & Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ==============================
      # 1. SETUP & CONFIGURATION
      # ==============================
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      # ==============================
      # 2. ROBUST SDK SETUP (2-Step Method)
      # ==============================
      - name: First attempt - Install SDK (Expect Failure)
        continue-on-error: true
        uses: android-actions/setup-android@v3
        with:
          packages: 'platform-tools platforms;android-34 build-tools;34.0.0 cmdline-tools;latest'

      - name: Accept Licenses (Flutter + SDKManager Method)
        run: |
          if command -v flutter >/dev/null 2>&1; then
            flutter doctor --android-licenses --verbose || true
          fi
          export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$PATH"
          yes | sdkmanager --licenses || true
          if [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
            yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          fi
          sdkmanager --update || true

      - name: Second attempt - Install SDK (Success)
        uses: android-actions/setup-android@v3
        with:
          packages: 'platform-tools platforms;android-34 build-tools;34.0.0 cmdline-tools;latest'

      - name: Make gradlew executable
        run: chmod +x gradlew

      # ==============================
      # 3. FAST BUILD (NO LINTING)
      # ==============================
      
      # On normal pushes, just verify we can build a release APK (Unsigned)
      - name: Build Release APK (Basic - Unsigned)
        if: startsWith(github.ref, 'refs/tags/') != true
        run: ./gradlew assembleBasicRelease --stacktrace

      - name: Upload Unsigned Artifact
        if: startsWith(github.ref, 'refs/tags/') != true
        uses: actions/upload-artifact@v4
        with:
          name: app-release-unsigned
          path: app/build/outputs/apk/basic/release/*.apk

      # ==============================
      # 4. RELEASE & SIGNING (TAGS ONLY)
      # ==============================
      - name: Save version tag
        if: startsWith(github.ref, 'refs/tags/')
        run: echo "VERSION_TAG=${GITHUB_REF/refs\/tags\//}" >> $GITHUB_ENV

      - name: Inject Secrets
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          echo "breezy.accu.key=$ACCU_WEATHER_KEY" >> local.properties
          echo "breezy.openweather.key=$OPEN_WEATHER_KEY" >> local.properties
        env:
          ACCU_WEATHER_KEY: ${{ secrets.ACCU_WEATHER_KEY }}
          OPEN_WEATHER_KEY: ${{ secrets.OPEN_WEATHER_KEY }}

      # --- FREENET FLAVOR ---
      - name: Build & Sign Freenet
        if: startsWith(github.ref, 'refs/tags/')
        run: ./gradlew assembleFreenetRelease
        
      - name: Sign Freenet
        if: startsWith(github.ref, 'refs/tags/')
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: app/build/outputs/apk/freenet/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}

      - name: Process Freenet Artifacts
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          set -e
          find app/build/outputs/apk/freenet/release -name "*-signed.apk" -exec mv {} breezy-weather-${{ env.VERSION_TAG }}_freenet.apk \;
          sha256sum breezy-weather-${{ env.VERSION_TAG }}_freenet.apk | awk '{ print $1 }' > freenet_sha.txt
          echo "APK_FREENET_SHA=$(cat freenet_sha.txt)" >> $GITHUB_ENV

      # --- BASIC FLAVOR ---
      - name: Build & Sign Basic
        if: startsWith(github.ref, 'refs/tags/')
        run: ./gradlew assembleBasicRelease

      - name: Sign Basic
        if: startsWith(github.ref, 'refs/tags/')
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: app/build/outputs/apk/basic/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}

      - name: Process Basic Artifacts
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          set -e
          find app/build/outputs/apk/basic/release -name "*-signed.apk" -exec mv {} breezy-weather-${{ env.VERSION_TAG }}_standard.apk \;
          sha256sum breezy-weather-${{ env.VERSION_TAG }}_standard.apk | awk '{ print $1 }' > standard_sha.txt
          echo "APK_STANDARD_SHA=$(cat standard_sha.txt)" >> $GITHUB_ENV
          if [ -d "app/build/outputs/mapping/basicRelease/" ]; then
            tar -czvf mapping-${{ env.VERSION_TAG }}_standard.tar.gz -C app/build/outputs/mapping/basicRelease mapping.txt
          fi

      # ==============================
      # 5. PUBLISH TO GITHUB
      # ==============================
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: Breezy Weather ${{ env.VERSION_TAG }}
          files: |
            breezy-weather-*.apk
            mapping-*.tar.gz
          body: |
            **Installation:** Download `breezy-weather-${{ env.VERSION_TAG }}_standard.apk`
            
            ### Checksums (SHA-256)
            | Flavor | SHA-256 |
            | :--- | :--- |
            | Standard | ${{ env.APK_STANDARD_SHA }} |
            | Freenet | ${{ env.APK_FREENET_SHA }} |

      - name: Cleanup
        if: always()
        run: rm -f local.properties